<!-- fragments/pedidosScreen.html -->
<div th:fragment="pedidosTela" id="pedidosTela" class="tela">
    <!-- <h1>Pedidos Screen</h1> -->
    <div class="divPedidos">
        <div class="lista-pedidos">
            <button id="listarBtn" onclick="listarPedidos()">Listar Pedidos</button>
            <div>
                <h2>Pedidos Cadastrados</h2>
            </div>
            <div id="listaPedidos"></div>


        </div>

    </div>


    <script>
        function listarPedidos() {
            fetch("/listar-pedidos")
                .then(response => response.json())
                .then(data => {
                    const listaContainer = document.getElementById("listaPedidos");
                    listaContainer.innerHTML = "";

                    if (data.length === 0) {
                        listaContainer.innerHTML += "<p>Nenhum pedido encontrado.</p>";
                        return;
                    }

                    data.forEach((pedido, index) => {
                        const pedidoDiv = document.createElement("div");
                        pedidoDiv.classList.add("pedido");

                        // let pedidoHTML = `<h3>Pedido ${index + 1} - Tipo: ${pedido.tipo} - Status: ${pedido.statusOrderProduction}</h3>`;

                        const corTampa = corTextoBlocoTampa(pedido.tampa || pedido.corTampa); // suporta os dois nomes

                        let pedidoHTML = `<h3 style="margin-bottom: 5px;">Pedido: <span style="font-weight: normal;">${index + 1}</span></h3> 
                                          <p><strong>Tipo:</strong> ${pedido.tipo}</p>
                                          <p><strong>Cor da tampa: <span style="color: ${corTampa.css}; font-weight: bold;">${corTampa.nome}</span></p>
                                          <p><strong>Status:</strong> ${pedido.statusOrderProduction}</p>`;

                        if (pedido.statusOrderProduction && pedido.statusOrderProduction.toLowerCase() === "pendente") {
                            pedidoHTML += `<button onclick="carregarPedidoPendente(${pedido.id})" style="margin-top: 10px; margin-bottom: 10px;">Enviar para produção</button>`;
                        }

                        pedidoDiv.innerHTML = pedidoHTML;

                        pedido.blocos.forEach((bloco, i) => {
                            const blocoDiv = document.createElement("div");

                            const corBloco = corTextoBlocoTampa(bloco.cor || bloco.corBloco); // suporta os dois nomes
                            blocoDiv.innerHTML = `<div style="margin-top: 10px;"><strong>Bloco ${i + 1}</strong> - Cor: <span style="color: ${corBloco.css}; font-weight: bold;">${corBloco.nome}</span></div>`;

                            // blocoDiv.innerHTML = `<strong>Bloco ${i + 1}</strong> - Cor: <span style="color: ${corBloco.css}; font-weight: bold;">${corBloco.nome}</span><br>`;

                            bloco.laminas.forEach((lamina, j) => {
                                const corLamina = corTextoLamina(lamina.cor);
                                blocoDiv.innerHTML += `&nbsp;&nbsp;Lâmina ${j + 1} - Cor: <span style="color: ${corLamina.css}; font-weight: bold;">${corLamina.nome}</span>, Padrão: ${lamina.padrao}<br>`;
                            });

                            pedidoDiv.appendChild(blocoDiv);
                        });

                        listaContainer.appendChild(pedidoDiv);
                    });
                })
                .catch(() => {
                    alert("Erro ao carregar pedidos.");
                });
        }

        // Função auxiliar para mapear número da cor para nome e cor CSS
        function corTextoBlocoTampa(codigo) {
            switch (codigo) {
                case 1:
                    return { nome: "PRETO", css: "black" };
                case 2:
                    return { nome: "VERMELHO", css: "red" };
                case 3:
                    return { nome: "AZUL", css: "blue" };
                default:
                    return { nome: "NENHUM", css: "gray" };
            }
        }
        // Função auxiliar para mapear número da cor para nome e cor CSS
        function corTextoLamina(codigo) {
            switch (codigo) {
                case 1:
                    return { nome: "VERMELHO", css: "red" };
                case 2:
                    return { nome: "AZUL", css: "blue" };
                case 3:
                    return { nome: "AMARELO", css: "goldenrod" };
                case 4:
                    return { nome: "VERDE", css: "green" };
                case 5:
                    return { nome: "PRETO", css: "black" };
                case 6:
                    return { nome: "BRANCO", css: "lightgray" }; // branco não aparece bem em fundo branco
                default:
                    return { nome: "NENHUM", css: "gray" };
            }
        }

        function carregarPedidoPendente(id) {
            fetch(`/listar-pedido/${id}`)
                .then(res => res.json())
                .then(pedido => {
                    carregarPedidoNaTela(pedido);
                })
                .catch(() => alert("Erro ao carregar pedido para execução."));
        }

        function carregarPedidoNaTela(pedido) {
            showTela('lojaTela');
            document.getElementById("tipoPedido").value = pedido.tipo;
            renderBlocos(); // Gera os blocos na interface

            document.getElementById("pedido-id").innerText = "Pedido #" + pedido.id;
            setTimeout(() => {
                pedido.blocos.forEach((bloco, i) => {
                    const n = i + 1;

                    document.getElementById(`block-color-${n}`).value =
                        bloco.cor === 1 ? "preto" :
                            bloco.cor === 2 ? "vermelho" : "azul";

                    // document.getElementById("pedido-view" + n).dataset.isSpun = "false";
                    changePedidoView(n);

                    bloco.laminas.forEach((lamina, j) => {
                        document.getElementById(`l${j + 1}-color-${n}`).value = lamina.cor;
                        document.getElementById(`l${j + 1}-pattern-${n}`).value = lamina.padrao;
                    });

                    changePedidoView(n);
                });

                revisarPedido(); // Atualiza visual
            }, 200);
        }

        function montarPedidoDTO(tipo, blocos, ipClp) {
            return {
                tipo: tipo,
                ipClp: ipClp,
                blocos: blocos
            };
        }

        function atualizarStatusPedidoConcluido(id) {
            fetch("/salvar-pedido/status", {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    id: id,
                    statusOrderProduction: "concluido"
                })
            });
        }

        // Executa o pedido pendente carregado da lista
        function executarPedidoPendente() {
            const tipo = document.getElementById("tipoPedido").value;
            const ipClp = document.getElementById("hostIpEstoque").value;

            if (!ipClp) {
                alert("Por favor, informe o IP do CLP.");
                return;
            }

            let blocosCount = tipo === "simples" ? 1 : tipo === "duplo" ? 2 : 3;
            let blocos = [];

            for (let b = 1; b <= blocosCount; b++) {
                const corBlocoInput = document.getElementById(`block-color-${b}`);
                let corBloco = 3; // Padrão: azul
                if (corBlocoInput.value === "preto") corBloco = 1;
                else if (corBlocoInput.value === "vermelho") corBloco = 2;

                let bloco = {
                    andar: b,
                    corBloco: corBloco,
                    laminas: []
                };

                for (let l = 1; l <= 3; l++) {
                    const cor = parseInt(document.getElementById(`l${l}-color-${b}`).value || 0);
                    const padrao = parseInt(document.getElementById(`l${l}-pattern-${b}`).value || 0);

                    bloco.laminas.push({
                        numero: l,
                        cor: cor,
                        padrao: padrao
                    });
                }

                blocos.push(bloco);
            }

            const pedidoDTO = montarPedidoDTO(tipo, blocos, ipClp);

            fetch("/iniciar-pedido", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(pedidoDTO)
            })
                .then(response => {
                    if (response.ok) {
                        alert("Pedido executado com sucesso!");
                        atualizarStatusPedidoConcluido(tipo);
                        listarPedidos();
                    } else {
                        alert("Erro ao executar pedido.");
                    }
                })
                .catch(error => {
                    console.error("Erro:", error);
                    alert("Erro na comunicação com o servidor.");
                });
        }
    </script>

</div>